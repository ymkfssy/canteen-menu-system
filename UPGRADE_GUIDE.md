# 升级指南 - 自定义分类功能

## 📝 更新内容

本次更新主要包含两个部分：

### 1. ✅ 增大前台菜品字体
- **菜品名称**：从 15px 增大到 **18px**
- **菜品价格**：从 17px 增大到 **20px**
- 字体大小适中，不会超出控制区域

### 2. ✅ 支持自定义分类
- 后台可以添加/编辑/删除自定义分类
- 前台自动展示自定义分类及其菜品
- 自定义分类数据同步到数据库
- 支持 Excel 导入导出自定义分类

---

## 🚀 部署步骤

由于数据库结构有变化，需要重新初始化数据库：

### 方式一：更新现有数据库（推荐）

```bash
# 1. 执行新的SQL语句添加默认分类数据
npx wrangler d1 execute canteen_menu_db --command="INSERT OR IGNORE INTO categories (name, key) VALUES ('凉菜', 'coldDishes'), ('热菜', 'hotDishes'), ('主食', 'stapleFood'), ('汤品', 'soup'), ('水果', 'fruit')"
```

### 方式二：重新创建数据库（如果遇到问题）

```bash
# 1. 备份当前菜单（可选）
# 在后台导出Excel保存数据

# 2. 删除旧数据库（在 Cloudflare Dashboard）
# 或者创建新数据库：
npx wrangler d1 create canteen_menu_db_v2

# 3. 更新 wrangler.toml 中的 database_id

# 4. 初始化新数据库
npx wrangler d1 execute canteen_menu_db_v2 --file=database/schema.sql

# 5. 重新导入菜单数据（使用之前导出的Excel）
```

### 部署到 Cloudflare Pages

```bash
# 部署更新后的代码
npm run deploy
```

或使用 PowerShell 脚本：

```powershell
.\deploy.ps1
```

---

## 🎯 新功能使用说明

### 后台管理

1. **添加自定义分类**
   - 登录后台：`https://your-domain.pages.dev/admin/`
   - 点击侧边栏"分类管理"
   - 点击"添加分类"按钮
   - 输入分类名称（如：小菜）和键名（如：xiaocai）
   - 保存后，分类会自动出现在"当前菜单"编辑区

2. **编辑/删除分类**
   - 在分类管理页面，点击自定义分类的"编辑"或"删除"按钮
   - **注意**：默认分类（凉菜、热菜、主食、汤品、水果）不可删除

3. **为自定义分类添加菜品**
   - 在"当前菜单"页面，找到对应分类
   - 点击"+ 添加XX"按钮
   - 填写菜品信息并保存

### 前台展示

- 自定义分类会自动显示在前台
- 颜色主题会自动应用（使用循环配色方案）
- 只显示有菜品的分类（空分类不显示）

---

## 📊 数据库变更

### 更新的表

**categories 表**：添加了默认分类初始数据
```sql
INSERT OR IGNORE INTO categories (name, key) VALUES 
    ('凉菜', 'coldDishes'),
    ('热菜', 'hotDishes'),
    ('主食', 'stapleFood'),
    ('汤品', 'soup'),
    ('水果', 'fruit');
```

### 新增的 API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/categories` | GET | 获取所有分类 |
| `/api/categories` | POST | 创建新分类 |
| `/api/categories/{id}` | DELETE | 删除分类 |

---

## 🔄 数据迁移

### Excel 导入导出兼容性

- ✅ 支持导入包含自定义分类的Excel
- ✅ 导出时会包含所有分类（默认+自定义）
- ✅ Excel 格式保持不变，第一列为分类名称

**Excel 格式示例：**
```
分类    | 菜品名称 | 价格 | 畅销  | 推荐
--------|----------|------|-------|------
凉菜    | 拍黄瓜   | 5元  | TRUE  | FALSE
小菜    | 泡菜     | 3元  | FALSE | TRUE
```

---

## ⚠️ 注意事项

1. **分类键名规则**
   - 只能包含字母和数字（a-z, A-Z, 0-9）
   - 不能与现有分类重复
   - 建议使用拼音，如：`xiaocai`, `yinpin`

2. **删除分类影响**
   - 删除自定义分类会同时删除该分类下的所有菜品
   - 删除操作不可恢复，请谨慎操作

3. **浏览器兼容**
   - 使用 localStorage 临时缓存分类数据
   - 清除浏览器缓存不会影响数据库中的数据

4. **字体大小**
   - 新的字体大小已优化，不会超出区域
   - 菜品过多时会自动调整间距

---

## 🐛 故障排除

### 问题1：后台添加分类后前台不显示

**解决方案：**
1. 检查该分类下是否有菜品（空分类不显示）
2. 清除浏览器缓存并刷新
3. 检查浏览器控制台是否有错误信息

### 问题2：Excel 导入自定义分类失败

**解决方案：**
1. 确保Excel第一列的分类名称与后台添加的一致
2. 检查分类键名是否正确
3. 先在后台手动添加分类，再导入菜品

### 问题3：字体显示异常

**解决方案：**
1. 清除浏览器缓存
2. 检查是否加载了最新的CSS文件
3. 尝试强制刷新（Ctrl+F5）

---

## 📞 技术支持

如遇到问题，请检查：
1. 浏览器控制台（F12）的错误信息
2. Cloudflare Pages 部署日志
3. D1 数据库连接状态

---

## 📅 版本信息

- **版本**：v2.0
- **更新日期**：2025-12-03
- **主要变更**：
  - 增大前台字体（18px/20px）
  - 支持自定义分类管理
  - 数据库结构优化
